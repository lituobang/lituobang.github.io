<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="title">研究贡献量化法计算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for academic aesthetic and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .primary { background-color: #1d4ed8; }
        .text-primary { color: #1d4ed8; }
        .bg-primary-light { background-color: #eef2ff; }
        .border-primary { border-color: #1d4ed8; }
        .tier-input:focus, .multi-input:focus {
            border-color: #1d4ed8;
            box-shadow: 0 0 0 1px #1d4ed8;
        }
        .org-card {
            border-left: 4px solid #3b82f6; /* Blue 500 */
        }
        .sub-org-card {
            border-left: 2px solid #10b981; /* Emerald 500 */
        }
        /* Group card color: Purple/Violet */
        .group-card {
             border-left: 2px solid #9333ea; /* Violet 600 */
        }
        /* Individual Participant/Sub-Participant card color: Amber */
        .participant-card {
            border-left: 2px solid #f59e0b; /* Amber 500 */
        }
        .sticky-top-section {
            position: sticky;
            top: 2rem; 
            z-index: 10;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1d4ed8', 
                        'secondary': '#374151',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8">
    <div class="container mx-auto max-w-7xl">
        <div class="flex justify-end mb-4">
    <select id="language-selector" class="rounded-md border border-gray-300 p-2 text-sm shadow-sm focus:ring-primary focus:border-primary">
        <option value="zh" selected>英文 English</option>
        <option value="en">中文 Chinese</option>
        <option value="bi">中英双语 Chinese & English</option>
    </select>
</div>

        <header class="text-center py-6 mb-8 bg-white rounded-xl shadow-lg border-t-4 border-primary">
            <h1 class="text-4xl font-bold text-secondary mb-2" data-key="header_title">研究贡献量化法计算器</h1>
            <p class="text-lg text-gray-500" data-key="header_subtitle">V5.2 - 三因素分档法</p>
        </header>

        <div class="grid grid-cols-1 lg:cols-3 gap-8">

            <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-primary mb-4 border-b pb-2" data-key="section_input_title">1. 输入贡献者姓名与三因素档位</h2>
                
                <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="font-bold text-secondary mb-2" data-key="csv_upload_label">导入初始值(CSV 文件；也可以在网页输入):</p>
                    <div class="flex items-center space-x-3">
                        
                        <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="updateFileInputLabel(this)"/>
                        
                        <label for="csvFile" id="customFileInputLabel" data-key="file_input_placeholder" class="py-2 px-4 rounded-full border border-gray-400 text-sm font-semibold bg-white text-gray-700 hover:bg-gray-100 cursor-pointer transition duration-150">
                            </label>

                        <button onclick="handleFileUpload()" class="py-2 px-4 border border-primary rounded-md shadow-sm text-white font-medium bg-primary hover:bg-blue-800 transition duration-150" data-key="button_upload_csv">
                            上传并替换
                        </button>
                    </div>
                    
                    <div class="flex justify-between items-center mt-2">
                         <p id="fileSelectedName" class="text-xs text-gray-500 italic" data-key="no_file_selected">（未选择任何文件）</p> 
                        <button onclick="downloadExampleFile()" class="py-1 px-3 text-xs border border-dashed border-gray-400 rounded-full text-gray-700 hover:bg-gray-100 transition duration-150" data-key="button_download_example">
                            下载示例文件 (UTF-8 格式)
                        </button>
                    </div>

                    <p id="uploadStatus" class="text-sm text-green-600 hidden mt-2"></p>
                    <p class="text-xs text-gray-500 mt-2" data-key="csv_upload_format_note">格式：请参考示例文件或汇总结果，包含9个字段（参与者/小组/子参与者 Participant/Group/Sub-Participant,是否属于某一小组 Belongs to a Group,小组名 Group Name,主要贡献项 Major Roles,小贡献项 Minor Roles,概率 Probability (P),因果关系 Causality (C),距离 Remoteness (R),数量 Multi,组数量 Group Multi）</p>
                </div>

                <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200 space-y-4">
                    
                    <div>
                        <p class="font-bold text-secondary mb-2" data-key="mode_combined_label">计算与加权模式选择:</p>
                        <div class="flex space-x-6">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="newCalculationMode" value="squaredAdditive" checked class="form-radio text-primary h-5 w-5" onchange="updateCalculationMode()">
                                <span class="ml-2 text-gray-800" data-key="mode_squared_additive">平方累加 ($\mathbf{S}+\mathbf{C}+\mathbf{B}$ & $\mathbf{R}^{\mathbf{2}}/\mathbf{\sum R}$) - 默认</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="newCalculationMode" value="linearMultiplicative" class="form-radio text-primary h-5 w-5" onchange="updateCalculationMode()">
                                <span class="ml-2 text-gray-800" data-key="mode_linear_multiplicative">线性相乘 ($\mathbf{S}_{\text{eff}} \times \mathbf{C}_{\text{eff}} \times \mathbf{B}_{\text{eff}}$ & $\mathbf{R}/\mathbf{\sum R}$)</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <p class="font-bold text-secondary mb-2" data-key="mode_ratio_label">比例分配模式:</p>
                        <div class="flex space-x-6">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="ratioMode" value="hierarchical" checked class="form-radio text-primary h-5 w-5" onchange="updateCalculationMode()">
                                <span class="ml-2 text-gray-800" data-key="mode_hierarchical">贡献项分级 ($\text{Ratio}_{\text{Large}} \times \text{Ratio}_{\text{Internal}}$) - 默认</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="ratioMode" value="global" class="form-radio text-primary h-5 w-5" onchange="updateCalculationMode()">
                                <span class="ml-2 text-gray-800" data-key="mode_global">参与者全局 ($\mathbf{R} / \mathbf{\sum R}$ or $\mathbf{R}^{\mathbf{2}} / \mathbf{\sum R}^{\mathbf{2}}$)</span>
                            </label>
                        </div>
                    </div>

                </div>
                <p class="text-sm text-red-500 mb-4" data-key="note_weight_removed">注意：务必确保参与者的姓名一致，否则汇总时会分开输出</p>
                
                <div id="largeOrgContainer" class="space-y-6">
                    </div>

                <button onclick="addLargeOrganization()" class="w-full mt-6 py-2 px-4 border border-primary rounded-md shadow-sm text-primary font-medium bg-white hover:bg-blue-50 transition duration-150 transform hover:scale-[1.005]" data-key="button_add_large_org">
                    + 添加大贡献项
                </button>
            </section>

            <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg flex flex-col h-fit sticky-top-section">
                <h2 class="text-2xl font-semibold text-primary mb-4 border-b pb-2" data-key="section_output_title">2. 计算与结果</h2>

                <button onclick="calculateContributions()" class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-white font-medium bg-primary hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 transform hover:scale-[1.01]" data-key="button_calculate">
                    计算最终贡献比例
                </button>
                
                <button id="downloadReportButton" onclick="downloadSummaryReport()" class="w-full py-3 px-4 mt-3 border border-green-500 rounded-md shadow-sm text-green-700 font-medium bg-green-50 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 transform hover:scale-[1.01] hidden" data-key="button_download_report">
                    下载汇总报告 (.csv)
                </button>
                
                <div id="errorBox" class="mt-4 p-3 rounded-md bg-red-100 text-red-700 border border-red-300 hidden" data-key="error_message_validation">
                    请确保所有组织的档位均已计算完成，且总档位不为零。
                </div>
                
                <div id="resultsContainer" class="mt-6 p-4 rounded-lg bg-gray-100 border-l-4 border-primary shadow-inner transition duration-300 ease-in-out hidden">
                    
                    <p class="text-lg font-semibold text-secondary mb-2" data-key="result_header_org">1. 大贡献项相对平均档位比例:</p>
                    <div id="largeOrgResults" class="space-y-2 mb-4">
                        </div>

                    <p class="text-lg font-semibold text-secondary mb-2 mt-4 border-t pt-2" data-key="result_header_participant">2. 最终参与者贡献比例 (明细):</p>
                    <div id="participantResults" class="space-y-2">
                        </div>

                    <p class="text-lg font-semibold text-secondary mb-2 mt-6 border-t-2 border-primary pt-2 bg-blue-50 p-1 rounded" data-key="result_header_aggregated">3. 最终参与者贡献比例汇总:</p>
                    <div id="participantAggregatedResults" class="space-y-2">
                        </div>
                </div>

            </section>
        </div>
        
    </div>

    <script>
        // --- Data Model and Rendering Functions ---
        // CSV 示例文件的内容，使用符合导入格式的中文内容
        // 最后一个字段 "组数量 (Group Multi)" 对应代码中的 factor_group_multi 变量。
const EXAMPLE_CSV_CONTENT = `#Section 2: Contribution Data Fields\r\nParticipant/Group/Sub-Participant,Belongs to a Group,Group Name,Major Roles,Minor Roles,Probability (P),Causality (C),Remoteness (R),Multi,Group Multi\r\nJohn Doe,No,,Organization,Data Curation,5,4,3,1,1\r\nTom,No,,Organization,Writing - Original Draft,4,3,2,1,1\r\nJane Doe,Yes,Development Team,Technology,Software,3,2,1,1,1\r\nMichael,Yes,Development Team,Innovation,Conceptualization,2,2,2,1,5\r\n`;
        let largeOrgs = []; // Global array to hold the entire hierarchical structure
        let nextParticipantId = 10000; // For individual participants (P) and sub-participants (S)
        let nextGroupId = 1000;        // For groups (G)
        let nextSmallOrgId = 100;
        let nextLargeOrgId = 1;
        
        // --- Calculation Modes Variables (Updated for new combined logic) ---
        // Default to 平方累加 (Squared Accumulation) = additive + squared
        let aggregationMode = 'additive'; // additive: S+C+B | multiplicative: S*C*B
        let weightingLogic = 'squared'; // linear: R / Sum(R) | squared: R^2 / Sum(R)
        let ratioMode = 'hierarchical'; // hierarchical: Org Ratio * Internal Ratio | global: Global R / Sum(Global R)

        function updateCalculationMode() {
            // New logic for combined mode
            const newModeElement = document.querySelector('input[name="newCalculationMode"]:checked');
            if (newModeElement) {
                const newMode = newModeElement.value;
                if (newMode === 'squaredAdditive') {
                    // 平方累加: 累加 (additive) + 平方加权 (squared)
                    aggregationMode = 'additive';
                    weightingLogic = 'squared';
                } else if (newMode === 'linearMultiplicative') {
                    // 线性相乘: 相乘 (multiplicative) + 线性加权 (linear)
                    aggregationMode = 'multiplicative';
                    weightingLogic = 'linear';
                }
            }

            // ratioMode remains independent
            ratioMode = document.querySelector('input[name="ratioMode"]:checked').value; 
            
            // Re-render and re-calculate scores to update score displays dynamically
            renderHierarchy(); 
            // Re-run intermediate calculations to update W_G, W_small, W_large displays
            largeOrgs.forEach(org => {
                org.smallOrgs.forEach(sub => {
                    sub.contributors.forEach(contributor => {
                        if (contributor.type === 'group') {
                            calculateGroupScore(org.id, sub.id, contributor.id);
                        }
                    });
                    calculateSmallOrgScore(org.id, sub.id);
                });
                calculateLargeOrgScore(org.id);
            });
        }

        // 用于报告生成的全局存储变量
        let currentAggregatedResults = [];
        let currentFinalOrgRatios = [];
        let currentDetailedResults = []; 

        // 中文版默认结构: 中文 (English)
        function getDefaultStructureZH() {
             return {
                "Organization": [
                    "Data Curation",
                    "Writing - Original Draft",
                    "Writing - Review & Editing",
                    "Supervision",
                    "Project administration"
                ],
                "Technology": [
                    "Visualization",
                    "Formal analysis",
                    "Validation",
                    "Software",
                    "Investigation",
                    "Technical References"
                ],
                "Labor": [
                    "Investigation"
                ],
                "Innovation": [
                    "Conceptualization",
                    "Methodology",
                    "Innovation References"
                ],
                "External Support": [
                    "Funding acquisition",
                    "Funding",
                    "Resources"
                ]
            };
        }


        
        let customHierarchyStructure = null;


        const translations = {
            zh: {
                title: "QuIReC Calculator",
                header_title: "QuIReC Calculator",
                header_subtitle: "V5.2 - Three-Factor Tiering Method", // Updated
                section_input_title: "1. Input Contributors and Three-Factor Tiers",
                section_output_title: "2. Calculation and Results",
                button_add_large_org: "+ Add Major Contribution Role",
                button_calculate: "Calculate Final Ratios",
                button_download_report: "Download Summary Report (.csv)",
                button_download_example: "Download Example File (UTF-8 Format)",
                error_message_validation: "Please ensure all Tiers are calculated and the total score is not zero.",
                result_header_org: "1. Major Role Relative Ratio:",
                result_header_participant: "2. Participant Contribution Ratios (Detail):",
                result_header_aggregated: "3. Total Aggregated Contribution Summary:",
                note_weight_removed: "Note: Please ensure participant names are consistent; otherwise, they will be listed separately in the summary.",
                
                large_org_name_placeholder: "Major Role (e.g.: Organization)",
                small_org_name_placeholder: "Minor Role (e.g.: Data Curation)",
                
                participant_name_placeholder: "Individual Participant (e.g.: John Doe)", // Updated
                group_name_placeholder: "Group Name (e.g.: R&D Team)", // NEW
                sub_participant_name_placeholder: "Sub-Participant (e.g.: Member A)", // NEW
                
                button_add_small_org: "+ Add Minor Role",
                button_add_contributor: "+ Add Contributor", // New generic button
                button_add_individual: "Add Individual Participant", // New modal buttons
                button_add_group: "Add Group", // NEW modal buttons
                button_add_sub_participant: "+ Add Sub-Participant", // NEW
                button_remove: "Remove",
                
                factor_scarcity: "Probability (P)",
                factor_causality: "Causality (C)",
                factor_breakthrough: "Remoteness(R)",
                factor_multi: "Multi", 
                factor_group_multi: "Group Multi", // NEW
                
                tier_input_placeholder: "Enter Tier (>=0)",
                placeholder_select: "Select Tier (1-6)",

                large_org_score_label: "Major Role Avg Tier:",
                small_org_score_label: "Minor Role Avg Tier:",
                group_avg_tier: "Group Avg Tier:", // NEW
                group_effective_score: "Group Total Effective Score:", // NEW
                sub_participant_effective_score: "Sub-Participant Effective Score:", // NEW
                
                button_calculate_small_org: "Calc Minor Role Tier",
                button_calculate_large_org: "Calc Major Role Tier",
                invalid_input: "Incomplete input or zero tier",

                // 修改后的模式选项
                mode_combined_label: "Calculation & Weighting Mode:", // NEW
                mode_squared_additive: "Squared Accumulation (P + C + R & Score² / ΣScore) - Default", // NEW
                mode_linear_multiplicative: "Linear Multiplication (P × C × R & Score / ΣScore)", // NEW
                
                // 保留比例分配模式
                mode_ratio_label: "Ratio Computation Mode:",
                mode_hierarchical: "Hierarchical Role - Default",
                mode_global: "Global Participant",
                
                report_title: "QuIReC Summary Report",
                report_date: "Generation Date",
                report_mode: "Calculation Mode",
                report_major_roles: "Major Role Relative Ratios",
                report_name: "Participant Name",
                report_ratio: "Total Contribution Ratio",
                report_detail_header: "Contribution Ratio Details (Including Input Tiers)",
                report_detail_role: "Role",
                report_detail_tier: "Three-Factor Tiers (P, C, R)",
                report_detail_score: "Raw Score",
                report_detail_squared: "Squared Contribution",
                report_detail_type: "Contributor Type", // NEW
                report_detail_group: "Parent Group", // NEW
                
                csv_upload_label: "Import Initial Data (CSV File; You can also input in the website):",
                button_upload_csv: "Upload & Replace",
                csv_upload_success: "Successfully imported contribution data and initialized calculation!", // 略微修改成功提示
                csv_upload_error: "Import failed. Please check the file format (ensure the correct 'Contribution Data Fields' header and at least one row of data are present), and confirm file encoding is UTF-8.", // 更新错误提示
                csv_upload_format_note: "Format: Should be the Example File or Summary Report, containing 9 fields (Participant/Group/Sub-Participant,Belongs to a Group,Group Name,Major Roles,Minor Roles,Probability (P),Causality (C),Remoteness (R),Multi,Group Multi). Please ensure file encoding is UTF-8.", // 更新格式说明
                file_input_placeholder: "Choose CSV File",                
                file_ready: "File Selected",
                no_file_selected: "(No file selected)",
            }        };

        function getLang() {
            return document.getElementById('language-selector')?.value || 'zh';
        }

        function getDisplayableName(name) {
            return name;
        }

        // --- UI Component Generation (Updated for Group/Sub-Participant) ---

        /**
         * Creates HTML for an Individual Participant or a Sub-Participant.
         * @param {number} orgId - Large Org ID.
         * @param {number} subOrgId - Small Org ID.
         * @param {Object} contributor - The participant/sub-participant object.
         * @param {number|null} [groupId=null] - Parent Group ID if it is a Sub-Participant.
         * @returns {string} HTML string.
         */
        function createParticipantHtml(orgId, subOrgId, contributor, groupId = null) {
            const keys = translations[getLang()];
            const isSub = groupId !== null;
            const parentId = isSub ? groupId : subOrgId;
            const parentType = isSub ? 'group' : 'smallOrg';
            const cardClass = isSub ? 'participant-card ml-8 bg-amber-50' : 'participant-card ml-4 bg-white';
            
            // Function to create input fields
            const createTierInput = (factor, currentValue) => `
                <input 
                    type="number"
                    min="0"
                    value="${currentValue}"
                    oninput="updateParticipantData(${orgId}, ${subOrgId}, ${parentId}, '${parentType}', ${contributor.id}, '${factor}', this.value)"
                    placeholder="${keys.tier_input_placeholder}"
                    class="tier-input mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1 text-xs border focus:ring-primary focus:border-primary"
                />
            `;
            const createMultiInput = (factor, currentValue) => `
                <input 
                    type="number"
                    min="1"
                    value="${currentValue}"
                    oninput="updateParticipantData(${orgId}, ${subOrgId}, ${parentId}, '${parentType}', ${contributor.id}, '${factor}', this.value)"
                    placeholder="1"
                    class="multi-input mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1 text-xs border focus:ring-primary focus:border-primary"
                />
            `;

            // Calculate current raw and effective score
            const currentRawScore = getContributorRawScore(contributor).toFixed(2);
            const currentEffectiveScore = getContributorEffectiveAllocationScore(contributor).toFixed(2);
            const removeFunc = isSub ? `removeSubParticipant(${orgId}, ${subOrgId}, ${groupId}, ${contributor.id})` : `removeContributor(${orgId}, ${subOrgId}, ${contributor.id})`;
            const placeholder = isSub ? keys.sub_participant_name_placeholder : keys.participant_name_placeholder;
            const scoreLabel = isSub ? keys.sub_participant_effective_score : keys.group_effective_score; // Note: for individual participant, A_P is the score

            return `
                <div id="participant-${contributor.id}" class="${cardClass} p-3 rounded-lg mb-2 relative">
                    <div class="flex items-center justify-between">
                        <input type="text" value="${contributor.name}" 
                            oninput="updateParticipantData(${orgId}, ${subOrgId}, ${parentId}, '${parentType}', ${contributor.id}, 'name', this.value)"
                            placeholder="${placeholder}" 
                            class="font-medium text-secondary text-sm w-1/4 p-1 rounded-md border-gray-300 border focus:ring-primary focus:border-primary">
                        
                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                            <span class="mr-4">Score: <strong>${currentRawScore}</strong></span> 
                            <span class="mr-4">${scoreLabel.split(':')[0]} (<span class="text-blue-600">Score * M</span>): <strong>${currentEffectiveScore}</strong></span>
                        </div>

                        <div class="flex space-x-2">
                            <button onclick="${removeFunc}" class="text-red-500 hover:text-red-700 text-sm font-semibold p-1">
                                ${keys.button_remove}
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-2 mt-2 text-xs">
                        <div><label class="block text-gray-500">${keys.factor_scarcity}</label>${createTierInput('scarcity', contributor.scarcity)}</div>
                        <div><div><label class="block text-gray-500">${keys.factor_causality}</label>${createTierInput('causality', contributor.causality)}</div></div>
                        <div><div><label class="block text-gray-500">${keys.factor_breakthrough}</label>${createTierInput('breakthrough', contributor.breakthrough)}</div></div>
                        <div><div><label class="block text-gray-500">${keys.factor_multi}</label>${createMultiInput('multi', contributor.multi)}</div></div>
                    </div>
                </div>
            `;
        }

        /**
         * Creates HTML for a Group Contributor.
         * @param {number} orgId - Large Org ID.
         * @param {number} subOrgId - Small Org ID.
         * @param {Object} group - The group object.
         * @returns {string} HTML string.
         */
        function createGroupHtml(orgId, subOrgId, group) {
            const keys = translations[getLang()];
            const subParticipantsHtml = group.subParticipants.map(p => createParticipantHtml(orgId, subOrgId, p, group.id)).join('');

            const scoreHtml = group.weightedAverageScore > 0 
                ? `<span class="text-sm font-semibold text-purple-700">${keys.group_avg_tier} ${group.weightedAverageScore.toFixed(2)}</span>`
                : `<span class="text-gray-500 text-sm italic">(${keys.group_avg_tier.split('(')[0]} --)</span>`;
            
            const effectiveScoreHtml = group.totalEffectiveAllocationScore > 0 
                ? `<span class="text-sm font-semibold text-blue-700">${keys.group_effective_score} ${group.totalEffectiveAllocationScore.toFixed(2)}</span>`
                : `<span class="text-gray-500 text-sm italic">(${keys.group_effective_score.split('(')[0]} --)</span>`;
            
            const createMultiInput = (currentValue) => `
                <input 
                    type="number"
                    min="1"
                    value="${currentValue}"
                    oninput="updateGroupData(${orgId}, ${subOrgId}, ${group.id}, 'multi', this.value)"
                    placeholder="1"
                    class="multi-input mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1 text-sm border focus:ring-primary focus:border-primary"
                />
            `;

            return `
                <div id="group-${group.id}" class="group-card p-4 bg-violet-50 rounded-lg shadow-md mb-2 ml-4">
                    <div class="flex items-center justify-between mb-3">
                        <input type="text" value="${group.name}" 
                            oninput="updateGroupData(${orgId}, ${subOrgId}, ${group.id}, 'name', this.value)"
                            placeholder="${keys.group_name_placeholder}" 
                            class="font-semibold text-base text-purple-700 w-1/4 p-1 rounded-md border-gray-300 border focus:ring-primary focus:border-primary">
                        
                        <div class="w-1/4 ml-4">
                            <label class="block text-gray-500 text-sm font-medium">${keys.factor_group_multi}</label>
                            ${createMultiInput(group.multi)}
                        </div>

                        <div class="flex items-center space-x-4">
                            <button onclick="calculateGroupScore(${orgId}, ${subOrgId}, ${group.id})" class="py-1 px-3 bg-purple-500 text-white text-sm rounded-md shadow hover:bg-purple-600 transition duration-150" data-key="button_calculate_group_score">
                                ${keys.button_calculate_small_org.replace('小贡献项 Minor Roles', '小组 Group')}
                            </button>
                            <div id="group-score-display-${group.id}" class="text-right">
                                ${scoreHtml}
                                ${effectiveScoreHtml}
                            </div>
                        </div>

                        <button onclick="removeContributor(${orgId}, ${subOrgId}, ${group.id})" class="text-red-500 hover:text-red-700 text-sm font-semibold p-1">
                            ${keys.button_remove}
                        </button>
                    </div>

                    <div id="sub-participants-container-${group.id}">
                        ${subParticipantsHtml}
                    </div>

                    <button onclick="addSubParticipant(${orgId}, ${subOrgId}, ${group.id})" class="mt-2 py-1 px-3 border border-dashed border-amber-500 rounded-md text-amber-600 text-xs hover:bg-amber-50 transition duration-150" data-key="button_add_sub_participant">
                        ${keys.button_add_sub_participant}
                    </button>
                </div>
            `;
        }

        function createSmallOrgHtml(orgId, subOrg) {
            const keys = translations[getLang()];
            const lang = getLang(); 
            
            const contributorsHtml = subOrg.contributors.map(contributor => {
                if (contributor.type === 'group') {
                    return createGroupHtml(orgId, subOrg.id, contributor);
                } else {
                    return createParticipantHtml(orgId, subOrg.id, contributor);
                }
            }).join('');

            const scoreHtml = subOrg.weightedAverageScore > 0 
                ? `<span class="text-sm font-semibold text-emerald-700">${keys.small_org_score_label} ${subOrg.weightedAverageScore.toFixed(2)}</span>`
                : `<span class="text-gray-500 text-sm italic">(${keys.small_org_score_label} --)</span>`;

            return `
                <div id="sub-org-${subOrg.id}" class="sub-org-card p-4 bg-gray-50 rounded-xl shadow-md mb-4 ml-4">
                    <div class="flex items-center justify-between mb-3">
                        <input type="text" value="${getDisplayableName(subOrg.name)}" 
                            oninput="updateSmallOrgData(${orgId}, ${subOrg.id}, 'name', this.value)"
                            placeholder="${keys.small_org_name_placeholder}" 
                            class="font-semibold text-lg text-emerald-700 w-1/3 p-1 rounded-md border-gray-300 border focus:ring-primary focus:border-primary">
                        
                        <span class="text-sm text-gray-600 italic"></span>

                        <button onclick="removeSmallOrganization(${orgId}, ${subOrg.id})" class="text-red-500 hover:text-red-700 text-sm font-semibold p-1">
                            ${keys.button_remove}
                        </button>
                    </div>

                    <div id="contributors-container-${subOrg.id}">
                        ${contributorsHtml}
                    </div>
                    
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-200">
                        <div class="dropdown inline-block relative">
                            <button onclick="toggleDropdown(this)" class="py-1 px-3 border border-dashed border-amber-500 rounded-md text-amber-600 text-sm hover:bg-amber-50 transition duration-150" data-key="button_add_contributor">
                                ${keys.button_add_contributor}
                            </button>
                            <div id="dropdown-${subOrg.id}" class="dropdown-menu absolute hidden text-gray-700 pt-1 z-10">
                                <a href="#" onclick="addIndividualParticipant(${orgId}, ${subOrg.id}); event.preventDefault();" class="bg-white hover:bg-gray-100 py-2 px-4 block whitespace-no-wrap border border-gray-300 rounded-t-md shadow-lg text-sm" data-key="button_add_individual">
                                    ${keys.button_add_individual}
                                </a>
                                <a href="#" onclick="addGroup(${orgId}, ${subOrg.id}); event.preventDefault();" class="bg-white hover:bg-gray-100 py-2 px-4 block whitespace-no-wrap border border-gray-300 rounded-b-md shadow-lg text-sm" data-key="button_add_group">
                                    ${keys.button_add_group}
                                </a>
                            </div>
                        </div>

                        <button onclick="calculateSmallOrgScore(${orgId}, ${subOrg.id})" class="py-1 px-3 bg-emerald-500 text-white text-sm rounded-md shadow hover:bg-emerald-600 transition duration-150" data-key="button_calculate_small_org">
                            ${keys.button_calculate_small_org}
                        </button>
                        <div id="small-org-score-display-${subOrg.id}">
                            ${scoreHtml}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function toggleDropdown(button) {
            const dropdown = button.nextElementSibling;
            dropdown.classList.toggle('hidden');
        }

        function createLargeOrgHtml(org) {
            const keys = translations[getLang()];
            const lang = getLang(); 
            
            const smallOrgsHtml = org.smallOrgs.map(subOrg => createSmallOrgHtml(org.id, subOrg)).join('');

            const scoreHtml = org.weightedAverageScore > 0 
                ? `<span class="text-base font-bold text-blue-700">${keys.large_org_score_label} ${org.weightedAverageScore.toFixed(2)}</span>`
                : `<span class="text-gray-500 text-base italic">(${keys.large_org_score_label} --)</span>`;

            return `
                <div id="large-org-${org.id}" class="org-card p-6 bg-primary-light rounded-xl shadow-xl mb-6">
                    <div class="flex items-center justify-between mb-4 pb-2 border-b border-blue-300">
                        <input type="text" value="${getDisplayableName(org.name)}" 
                            oninput="updateLargeOrgData(${org.id}, 'name', this.value)"
                            placeholder="${keys.large_org_name_placeholder}" 
                            class="font-bold text-xl text-blue-700 w-2/3 p-1 rounded-md border-gray-300 border focus:ring-primary focus:border-primary">
                        
                        <button onclick="removeLargeOrganization(${org.id})" class="text-red-500 hover:text-red-700 text-sm font-semibold p-1">
                            ${keys.button_remove}
                        </button>
                    </div>

                    <div id="small-orgs-container-${org.id}">
                        ${smallOrgsHtml}
                    </div>

                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-blue-300">
                        <button onclick="addSmallOrganization(${org.id})" class="py-2 px-4 border border-dashed border-emerald-500 rounded-md text-emerald-600 font-medium hover:bg-emerald-50 transition duration-150" data-key="button_add_small_org">
                            ${keys.button_add_small_org}
                        </button>
                        <button onclick="calculateLargeOrgScore(${org.id})" class="py-2 px-4 bg-blue-500 text-white font-medium rounded-md shadow hover:bg-blue-600 transition duration-150" data-key="button_calculate_large_org">
                            ${keys.button_calculate_large_org}
                        </button>
                        <div id="large-org-score-display-${org.id}">
                            ${scoreHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHierarchy() {
            const container = document.getElementById('largeOrgContainer');
            container.innerHTML = largeOrgs.map(org => createLargeOrgHtml(org)).join('');
        }

        // --- CRUD Functions (Updated for Group/Sub-Participant) ---

        /** Finds a contributor (Individual or Group) within a small org. */
        function findContributor(orgId, subOrgId, contributorId) {
            const org = largeOrgs.find(o => o.id === orgId);
            const subOrg = org?.smallOrgs.find(s => s.id === subOrgId);
            return subOrg?.contributors.find(c => c.id === contributorId);
        }
        
        /** Finds a sub-participant within a group. */
        function findSubParticipant(orgId, subOrgId, groupId, subParticipantId) {
            const group = findContributor(orgId, subOrgId, groupId);
            return group?.subParticipants.find(p => p.id === subParticipantId);
        }

        // --- Large/Small Org CRUD (Mostly Unchanged) ---

        function addLargeOrganization(nameOverride, smallOrgNames) {
            const keys = translations[getLang()];
            const newId = nextLargeOrgId++;
            
            const baseName = keys.large_org_name_placeholder.includes('(') 
                ? keys.large_org_name_placeholder.split('(')[0].trim() 
                : keys.large_org_name_placeholder.split(' ')[0].trim();
            const defaultName = `${baseName} ${String.fromCharCode(64 + newId)}`;


            const newOrg = {
                id: newId,
                name: nameOverride || defaultName, 
                weightedAverageScore: 0, 
                smallOrgs: []
            };
            largeOrgs.push(newOrg);
            
            if (smallOrgNames && smallOrgNames.length > 0) {
                smallOrgNames.forEach(smallOrgName => {
                    addSmallOrganization(newId, smallOrgName, false); 
                });
                renderHierarchy(); 
            } else {
                if (nameOverride === undefined) { 
                    addSmallOrganization(newId); 
                }
            }
        }
        
        function removeLargeOrganization(id) {
            largeOrgs = largeOrgs.filter(org => org.id !== id);
            renderHierarchy();
            calculateContributions();
        }

        function addSmallOrganization(orgId, nameOverride, addContributorFlag = true) {
            const org = largeOrgs.find(o => o.id === orgId);
            if (!org) return;

            const keys = translations[getLang()];
            const newId = nextSmallOrgId++;
            
            const baseName = keys.small_org_name_placeholder.includes('(') 
                ? keys.small_org_name_placeholder.split('(')[0].trim() 
                : keys.small_org_name_placeholder.split(' ')[0].trim();
            const defaultName = `${baseName} ${newId % 10}`;

            const newSubOrg = {
                id: newId,
                name: nameOverride || defaultName, 
                weightedAverageScore: 0, 
                contributors: [] // Changed from 'participants' to 'contributors'
            };
            org.smallOrgs.push(newSubOrg);
            
            if (addContributorFlag) {
                addIndividualParticipant(orgId, newId); // Default to adding an individual
                renderHierarchy(); 
            }
        }
        
        function removeSmallOrganization(orgId, subOrgId) {
            const org = largeOrgs.find(o => o.id === orgId);
            if (org) {
                org.smallOrgs = org.smallOrgs.filter(sub => sub.id !== subOrgId);
                renderHierarchy();
                calculateContributions();
            }
        }

        // --- Contributor CRUD (Individual Participant / Group) ---

        function addIndividualParticipant(orgId, subOrgId) {
            const org = largeOrgs.find(o => o.id === orgId);
            const subOrg = org?.smallOrgs.find(s => s.id === subOrgId);
            if (!subOrg) return;

            const keys = translations[getLang()];
            const newId = nextParticipantId++;
            
            const baseName = keys.participant_name_placeholder.includes('(') 
                ? keys.participant_name_placeholder.split('(')[0].trim() 
                : keys.participant_name_placeholder.split(' ')[0].trim();
            const defaultName = `${baseName} ${newId % 100}`;
            
            const newContributor = {
                id: newId,
                type: 'individual',
                name: defaultName,
                scarcity: 0, 
                causality: 0, 
                breakthrough: 0,
                multi: 1 
            };
            subOrg.contributors.push(newContributor);
            renderHierarchy();
        }

        function addGroup(orgId, subOrgId) {
            const org = largeOrgs.find(o => o.id === orgId);
            const subOrg = org?.smallOrgs.find(s => s.id === subOrgId);
            if (!subOrg) return;

            const keys = translations[getLang()];
            const newId = nextGroupId++;
            
            const baseName = keys.group_name_placeholder.includes('(') 
                ? keys.group_name_placeholder.split('(')[0].trim() 
                : keys.group_name_placeholder.split(' ')[0].trim();
            const defaultName = `${baseName} ${newId % 100}`;

            const newGroup = {
                id: newId,
                type: 'group',
                name: defaultName,
                weightedAverageScore: 0, // W_Group
                totalEffectiveAllocationScore: 0, // A_Group
                multi: 1, // M_Group (Independent Input)
                subParticipants: []
            };
            subOrg.contributors.push(newGroup);
            
            // Add a default sub-participant to the new group
            addSubParticipant(orgId, subOrgId, newId);
            renderHierarchy();
        }

        function removeContributor(orgId, subOrgId, contributorId) {
            const org = largeOrgs.find(o => o.id === orgId);
            const subOrg = org?.smallOrgs.find(s => s.id === subOrgId);
            if (subOrg) {
                subOrg.contributors = subOrg.contributors.filter(c => c.id !== contributorId);
                renderHierarchy();
                calculateContributions();
            }
        }

        function updateGroupData(orgId, subOrgId, groupId, key, value) {
            const group = findContributor(orgId, subOrgId, groupId);
            if (group) {
                if (key === 'name') {
                    group[key] = value;
                } else if (key === 'multi') {
                    let numericValue = parseFloat(value) || 1;
                    if (numericValue < 1) numericValue = 1;
                    group[key] = numericValue;
                }
            }
            if (key !== 'name') {
                calculateGroupScore(orgId, subOrgId, groupId); // Recalculate group score on tier/multi change
                calculateSmallOrgScore(orgId, subOrgId);
            }
            renderHierarchy(); // Re-render to update the calculated score display
        }

        // --- Sub-Participant CRUD ---
        
        function addSubParticipant(orgId, subOrgId, groupId) {
            const group = findContributor(orgId, subOrgId, groupId);
            if (!group || group.type !== 'group') return;

            const keys = translations[getLang()];
            const newId = nextParticipantId++;
            
            const baseName = keys.sub_participant_name_placeholder.includes('(') 
                ? keys.sub_participant_name_placeholder.split('(')[0].trim() 
                : keys.sub_participant_name_placeholder.split(' ')[0].trim();
            const defaultName = `${baseName} ${newId % 100}`;
            
            const newSubParticipant = {
                id: newId,
                name: defaultName,
                scarcity: 0, 
                causality: 0, 
                breakthrough: 0,
                multi: 1 
            };
            group.subParticipants.push(newSubParticipant);
            renderHierarchy();
        }

        function removeSubParticipant(orgId, subOrgId, groupId, subParticipantId) {
            const group = findContributor(orgId, subOrgId, groupId);
            if (group && group.type === 'group') {
                group.subParticipants = group.subParticipants.filter(p => p.id !== subParticipantId);
                // Recalculate group score as its members changed
                calculateGroupScore(orgId, subOrgId, groupId);
                calculateSmallOrgScore(orgId, subOrgId);
                renderHierarchy();
                calculateContributions();
            }
        }

        function updateParticipantData(orgId, subOrgId, parentId, parentType, contributorId, key, value) {
            let contributor;
            if (parentType === 'smallOrg') {
                contributor = findContributor(orgId, subOrgId, contributorId); // Individual Participant
            } else if (parentType === 'group') {
                contributor = findSubParticipant(orgId, subOrgId, parentId, contributorId); // Sub-Participant
            }

            if (contributor) {
                if (key === 'name') {
                    contributor[key] = value;
                    return; 
                } else if (key === 'multi') {
                    let numericValue = parseFloat(value) || 1;
                    if (numericValue < 1) numericValue = 1;
                    contributor[key] = numericValue;
                } else {
                    let numericValue = parseFloat(value) || 0;
                    contributor[key] = numericValue;
                }
            }
            
            // If sub-participant changed, need to update group score and then small org score
            if (parentType === 'group') {
                calculateGroupScore(orgId, subOrgId, parentId);
            }
            
            // If individual participant changed OR group score has been updated, update small org score
            calculateSmallOrgScore(orgId, subOrgId);
            renderHierarchy(); 
        }

        // --- CALCULATION HELPERS (Core Logic) ---

        /**
         * 计算个体/子参与者的原始总档位 R。
         * @param {Object} p - 参与者/子参与者对象 {scarcity, causality, breakthrough}
         * @returns {number} 原始总档位 R。
         */
        function getContributorRawScore(p) {
            const s = parseFloat(p.scarcity) || 0;
            const c = parseFloat(p.causality) || 0;
            const b = parseFloat(p.breakthrough) || 0;
            
            if (s === 0 && c === 0 && b === 0) {
                return 0;
            }

            if (aggregationMode === 'additive') {
                return s + c + b;
            } else if (aggregationMode === 'multiplicative') {
                const s_eff = Math.max(1, s);
                const c_eff = Math.max(1, c);
                const b_eff = Math.max(1, b);
                return s_eff * c_eff * b_eff;
            }
            return 0; 
        }

        /**
         * 获取用于比例分配的**原始**加权分数 (R 或 R^2)。不包含 Multi 因素。
         * @param {Object} p - 参与者/子参与者对象
         * @returns {number} 分配依据的原始分数 (R 或 R^2)。
         */
        function getContributorAllocationScore(p) {
            const rawScore = getContributorRawScore(p);
            if (weightingLogic === 'squared') {
                return rawScore * rawScore; 
            }
            return rawScore; 
        }
        
        /**
         * 获取最终用于分配的**有效**加权分数 (R * multi 或 R^2 * multi)。包含 Multi 因素。
         * @param {Object} p - 参与者/子参与者对象
         * @returns {number} 最终分配依据的有效分数 (R * multi 或 R^2 * multi)。
         */
        function getContributorEffectiveAllocationScore(p) {
            const allocationScore = getContributorAllocationScore(p); // R or R^2
            return allocationScore * (parseFloat(p.multi) || 1); 
        }

        function isContributorInputValid(p) {
             return getContributorRawScore(p) > 0;
        }

        // --- Group Calculation (NEW) ---

        /**
         * 计算小组的平均档位 (W_Group) 和有效分配分 (A_Group)。
         */
        function calculateGroupScore(orgId, subOrgId, groupId) {
            const group = findContributor(orgId, subOrgId, groupId);
            const scoreDisplay = document.getElementById(`group-score-display-${groupId}`);
            const keys = translations[getLang()];

            if (!group || !scoreDisplay || group.type !== 'group') return 0;
            
            let sumOfScoresForAvg = 0;   // Numerator (Sum R or Sum R^2)
            let sumOfWeightsForAvg = 0;  // Denominator (Sum R or Count)
            
            const validSubParticipants = group.subParticipants.filter(p => isContributorInputValid(p));

            if (group.subParticipants.length > 0 && validSubParticipants.length === 0) {
                group.weightedAverageScore = 0;
                group.totalEffectiveAllocationScore = 0;
                scoreDisplay.innerHTML = `<span class="text-red-500 text-xs">${keys.invalid_input}</span>`;
                return 0;
            }

            for (const p of validSubParticipants) {
                const rawScore = getContributorRawScore(p); // R (not R * M)

                if (weightingLogic === 'squared') {
                    // 平方加权: W = (Sum R^2) / (Sum R)
                    sumOfScoresForAvg += rawScore * rawScore; // R^2
                    sumOfWeightsForAvg += rawScore;           // R
                } else {
                    // 线性加权: W = (Sum R) / Count
                    sumOfScoresForAvg += rawScore;            // R
                    sumOfWeightsForAvg += 1;                  // Count
                }
            }
            
            if (sumOfWeightsForAvg === 0) {
                 group.weightedAverageScore = 0;
                 group.totalEffectiveAllocationScore = 0;
                 scoreDisplay.innerHTML = `<span class="text-gray-500 text-sm italic">(${keys.group_avg_tier.split('(')[0]} --)</span><br><span class="text-gray-500 text-sm italic">(${keys.group_effective_score.split('(')[0]} --)</span>`;
                 return 0;
            }

            // 1. Calculate Group Average Tier (W_Group)
            const groupWeightedAverage = sumOfScoresForAvg / sumOfWeightsForAvg;
            group.weightedAverageScore = groupWeightedAverage;
            
            // 2. Calculate Group Effective Allocation Score (A_Group)
            let groupAllocationScoreBase = groupWeightedAverage; // W_Group
            if (weightingLogic === 'squared') {
                groupAllocationScoreBase = groupAllocationScoreBase * groupAllocationScoreBase; // W_Group^2
            }
            
            // A_Group = (W_Group or W_Group^2) * M_Group
            const effectiveScore = groupAllocationScoreBase * (parseFloat(group.multi) || 1);
            group.totalEffectiveAllocationScore = effectiveScore;


            scoreDisplay.innerHTML = `
                <span class="text-sm font-semibold text-purple-700">${keys.group_avg_tier} ${groupWeightedAverage.toFixed(2)}</span><br>
                <span class="text-sm font-semibold text-blue-700">${keys.group_effective_score} ${effectiveScore.toFixed(2)}</span>
            `;
            
            // Return W_Group (Used by Small Org Average Tier calculation)
            return groupWeightedAverage;
        }


        // --- Small Org Calculation (Updated for Group) ---

        /**
         * 计算小组 (Small Org) 的平均档位 W。
         * W_small 不受 Multi 因素影响，仅反映角色平均分。
         */
        function calculateSmallOrgScore(orgId, subOrgId) {
            const org = largeOrgs.find(o => o.id === orgId);
            const smallOrg = org?.smallOrgs.find(s => s.id === subOrgId);
            const scoreDisplay = document.getElementById(`small-org-score-display-${subOrgId}`);
            const keys = translations[getLang()];

            if (!smallOrg || !scoreDisplay) return 0;

            let sumOfScoresForAvg = 0;   // Numerator (Sum R or Sum R^2 for Individuals, Sum W_G or Sum W_G^2 for Groups)
            let sumOfWeightsForAvg = 0;  // Denominator (Sum R or Count for Individuals, Sum W_G or Count for Groups)
            let totalParticipantsCount = 0;
            let totalValidContributors = 0;
            
            // 1. Gather scores from all contributors (Individuals AND Groups' Sub-Participants)
            smallOrg.contributors.forEach(contributor => {
                if (contributor.type === 'individual') {
                    totalParticipantsCount++;
                    if (isContributorInputValid(contributor)) {
                        totalValidContributors++;
                        const rawScore = getContributorRawScore(contributor);
                        
                        // Use R or R^2 for W_Small calculation (Ignore Multi)
                        if (weightingLogic === 'squared') {
                            sumOfScoresForAvg += rawScore * rawScore; // R^2
                            sumOfWeightsForAvg += rawScore;           // R
                        } else {
                            sumOfScoresForAvg += rawScore;            // R
                            sumOfWeightsForAvg += 1;                  // Count
                        }
                    }
                } else if (contributor.type === 'group') {
                    // Pre-calculate W_Group (This is needed for W_Small calculation)
                    const wGroup = calculateGroupScore(orgId, subOrgId, contributor.id); 
                    
                    if (wGroup > 0) {
                        totalValidContributors++;
                        // Use W_Group or W_Group^2 for W_Small calculation (Ignore M_Group)
                        if (weightingLogic === 'squared') {
                            sumOfScoresForAvg += wGroup * wGroup; // W_Group^2
                            sumOfWeightsForAvg += wGroup;         // W_Group
                        } else {
                            sumOfScoresForAvg += wGroup;          // W_Group
                            sumOfWeightsForAvg += 1;              // Count (of Groups)
                        }
                    }
                    totalParticipantsCount += contributor.subParticipants.length;
                }
            });
            
            const totalContributors = smallOrg.contributors.length;

            if (totalContributors > 0 && totalValidContributors === 0) {
                smallOrg.weightedAverageScore = 0;
                scoreDisplay.innerHTML = `<span class="text-red-500 text-sm">${keys.small_org_score_label.split(':')[0]} 0.00 (${keys.invalid_input})</span>`;
                return 0;
            }

            if (sumOfWeightsForAvg === 0) {
                 smallOrg.weightedAverageScore = 0;
                 scoreDisplay.innerHTML = `<span class="text-gray-500 text-sm italic">(${keys.small_org_score_label} --)</span>`;
                 return 0;
            }

            const smallOrgWeightedAverage = sumOfScoresForAvg / sumOfWeightsForAvg;
            smallOrg.weightedAverageScore = smallOrgWeightedAverage;
            
            scoreDisplay.innerHTML = `<span class="text-sm font-semibold text-emerald-700">${keys.small_org_score_label} ${smallOrgWeightedAverage.toFixed(2)}</span>`;
            return smallOrgWeightedAverage;
        }

        // --- Large Org Calculation (Unchanged in Logic) ---

        function calculateLargeOrgScore(orgId) {
            const largeOrg = largeOrgs.find(o => o.id === orgId);
            const scoreDisplay = document.getElementById(`large-org-score-display-${orgId}`);
            const keys = translations[getLang()];

            if (!largeOrg || !scoreDisplay) return 0;

            let sumOfScoresForAvg = 0;
            let sumOfWeightsForAvg = 0;
            let allSmallOrgsValid = true;

            if (largeOrg.smallOrgs.length === 0) {
                 largeOrg.weightedAverageScore = 0;
                scoreDisplay.innerHTML = `<span class="text-gray-500 text-base italic">(${keys.large_org_score_label} --)</span>`;
                return 0;
            }
            
            for (const smallOrg of largeOrg.smallOrgs) {
                // This call calculates W_Small
                const smallOrgAverageScore = calculateSmallOrgScore(orgId, smallOrg.id); 
                
                if (smallOrgAverageScore === 0 && smallOrg.contributors.length > 0) {
                    // Check if any contributor is valid (simplified check based on W_Small result)
                    if (smallOrg.contributors.some(c => c.type === 'individual' && isContributorInputValid(c))) {
                         // An individual participant exists but W_Small is zero (should not happen if isContributorInputValid is correct)
                    }
                    // If W_Small is 0 but there are contributors, it's considered invalid for hierarchical calculation
                    if (smallOrg.contributors.length > 0 && smallOrgAverageScore === 0) {
                        allSmallOrgsValid = false;
                    }
                    if (!allSmallOrgsValid) break; 
                }
                
                if (smallOrgAverageScore > 0) {
                    if (weightingLogic === 'squared') {
                        // W = (Sum W_small^2) / (Sum W_small)
                        sumOfScoresForAvg += smallOrgAverageScore * smallOrgAverageScore; // W_small^2
                        sumOfWeightsForAvg += smallOrgAverageScore;                      // W_small
                    } else {
                        // W = (Sum W_small) / Count
                        sumOfScoresForAvg += smallOrgAverageScore;                       // W_small
                        sumOfWeightsForAvg += 1;                                         // Count
                    }
                }
            }
            
            if (!allSmallOrgsValid || sumOfWeightsForAvg === 0) {
                largeOrg.weightedAverageScore = 0;
                const errorMsg = !allSmallOrgsValid ? keys.invalid_input : keys.large_org_score_label.split(':')[0] + ' 0.00';
                scoreDisplay.innerHTML = `<span class="text-red-500 text-base">${keys.large_org_score_label.split(':')[0]} 0.00 (${errorMsg})</span>`;
                return 0;
            }

            const largeOrgWeightedAverage = sumOfScoresForAvg / sumOfWeightsForAvg;
            largeOrg.weightedAverageScore = largeOrgWeightedAverage;
            
            scoreDisplay.innerHTML = `<span class="text-base font-bold text-blue-700">${keys.large_org_score_label} ${largeOrgWeightedAverage.toFixed(2)}</span>`;
            return largeOrgWeightedAverage;
        }
        
        // --- Full Top-Down Allocation (Main Button) ---

        function calculateContributions() {
            const resultsContainer = document.getElementById('resultsContainer');
            const largeOrgResults = document.getElementById('largeOrgResults');
            const participantResults = document.getElementById('participantResults');
            const participantAggregatedResults = document.getElementById('participantAggregatedResults');
            const errorBox = document.getElementById('errorBox');
            const downloadButton = document.getElementById('downloadReportButton'); 
            const keys = translations[getLang()];
            
            let grandTotalAverageScore = 0; 
            let grandTotalAllocationScore = 0; 
            const calculatedOrgs = [];
            let isValid = largeOrgs.length >= 1;
            let totalParticipantCount = 0;
            
            currentAggregatedResults = [];
            currentFinalOrgRatios = [];
            currentDetailedResults = [];
            
            const ALL_FINAL_RESULTS = []; // Stores the final allocated ratio for every individual and sub-participant

            // 1. Pre-calculation: Calculate all W_Large and A_Global (if needed)
            for (const largeOrg of largeOrgs) {
                const largeOrgAverageScore = calculateLargeOrgScore(largeOrg.id);

                if (ratioMode === 'hierarchical' && largeOrgAverageScore === 0) {
                    isValid = false;
                    break;
                }
                
                if (ratioMode === 'hierarchical') {
                    let largeOrgScoreForRatio = largeOrgAverageScore;
                    if (weightingLogic === 'squared') {
                        largeOrgScoreForRatio = largeOrgScoreForRatio * largeOrgScoreForRatio;
                    }
                    grandTotalAverageScore += largeOrgScoreForRatio;
                }
                
                let totalSumOfEffectiveAllocationScoresInternal = 0; // Denominator for internal ratio: Sum(A_P + A_G)
                
                largeOrg.smallOrgs.forEach(smallOrg => {
                    smallOrg.contributors.forEach(contributor => {
                        if (contributor.type === 'individual') {
                            if(isContributorInputValid(contributor)) {
                                totalParticipantCount++;
                                const pEffectiveAllocationScore = getContributorEffectiveAllocationScore(contributor); 
                                totalSumOfEffectiveAllocationScoresInternal += pEffectiveAllocationScore;
                                if (ratioMode === 'global') {
                                    grandTotalAllocationScore += pEffectiveAllocationScore;
                                }
                            }
                        } else if (contributor.type === 'group') {
                            // Already calculated in calculateSmallOrgScore, contributor.totalEffectiveAllocationScore is A_Group
                            const aGroup = contributor.totalEffectiveAllocationScore;
                            
                            if (aGroup > 0) {
                                totalSumOfEffectiveAllocationScoresInternal += aGroup;
                                if (ratioMode === 'global') {
                                    grandTotalAllocationScore += aGroup;
                                }
                                totalParticipantCount += contributor.subParticipants.filter(p => isContributorInputValid(p)).length;
                            }
                        }
                    });
                });

                calculatedOrgs.push({
                    ...largeOrg,
                    weightedAverageScore: largeOrgAverageScore,
                    totalSumOfAllocationScores: totalSumOfEffectiveAllocationScoresInternal, 
                });
            }

            if (!isValid || totalParticipantCount < 1) {
                resultsContainer.classList.add('hidden');
                downloadButton.classList.add('hidden'); 
                errorBox.innerHTML = keys.error_message_validation;
                errorBox.classList.remove('hidden');
                return;
            }
            
            if ((ratioMode === 'hierarchical' && grandTotalAverageScore === 0) || (ratioMode === 'global' && grandTotalAllocationScore === 0)) {
                resultsContainer.classList.add('hidden');
                downloadButton.classList.add('hidden'); 
                errorBox.innerHTML = keys.error_message_validation;
                errorBox.classList.remove('hidden');
                return;
            }
            
            errorBox.classList.add('hidden');

            // 2. Final Proportional Allocation
            
            const scoreLabelBase = keys.large_org_score_label.endsWith(':') 
                ? keys.large_org_score_label.slice(0, -1) 
                : keys.large_org_score_label;

            const currentLang = getLang();

            // Loop through all calculated Large Orgs
            for (const largeOrg of calculatedOrgs) {
                
                // a. Large Org Ratio (Ratio_Large) or Global Ratio is 100%
                let largeOrgRatio = 100;
                if (ratioMode === 'hierarchical') {
                    let largeOrgAllocationScore = largeOrg.weightedAverageScore;
                    if (weightingLogic === 'squared') {
                        largeOrgAllocationScore = largeOrgAllocationScore * largeOrgAllocationScore;
                    }
                    largeOrgRatio = (largeOrgAllocationScore / grandTotalAverageScore) * 100;
                }
                
                if (ratioMode === 'hierarchical') {
                     currentFinalOrgRatios.push({ name: largeOrg.name, ratio: largeOrgRatio, score: largeOrg.weightedAverageScore });
                }

                // b. Internal Allocation (Individual Participant OR Group)
                largeOrg.smallOrgs.forEach(smallOrg => {
                    smallOrg.contributors.forEach(contributor => {
                        let contributorEffectiveScore; // A_P or A_G
                        let contributorFinalRatio = 0; // Final ratio allocated to this individual/group
                        
                        if (contributor.type === 'individual') {
                            if (!isContributorInputValid(contributor)) return;
                            contributorEffectiveScore = getContributorEffectiveAllocationScore(contributor);
                        } else if (contributor.type === 'group') {
                            contributorEffectiveScore = contributor.totalEffectiveAllocationScore;
                            if (contributorEffectiveScore === 0) return;
                        }

                        // Calculate contributor's proportion based on selected mode
                        if (ratioMode === 'global') {
                            contributorFinalRatio = (contributorEffectiveScore / grandTotalAllocationScore) * 100;
                        } else if (ratioMode === 'hierarchical') {
                            if (largeOrg.totalSumOfAllocationScores > 0) {
                                // Internal Ratio = A_Contributor / Sum(A_P + A_G)
                                const internalRatio = contributorEffectiveScore / largeOrg.totalSumOfAllocationScores; 
                                contributorFinalRatio = largeOrgRatio * internalRatio;
                            }
                        }

                        // c. Distribute the ratio
                        if (contributor.type === 'individual') {
                            // Individual Participant: Final ratio is found
                            const pRawScore = getContributorRawScore(contributor);
                            ALL_FINAL_RESULTS.push({
                                largeOrgName: largeOrg.name,
                                smallOrgName: smallOrg.name,
                                groupName: null,
                                name: contributor.name,
                                finalRatio: contributorFinalRatio,
                                type: 'Individual', // For report
                                scarcity: contributor.scarcity,
                                causality: contributor.causality,
                                breakthrough: contributor.breakthrough,
                                multi: contributor.multi,
                                factorGroupMulti: 1, // <<< FIX: 添加组数量（个体默认为1）
                                rawScore: pRawScore, 
                                allocationScore: contributorEffectiveScore // R*M or R^2*M
                            });
                        } else if (contributor.type === 'group') {
                            // Group: Need to distribute Ratio_Group to Sub-Participants
                            let sumOfSubEffectiveScores = 0; // Sum(A_s) for the group's internal ratio denominator
                            contributor.subParticipants.forEach(sub => {
                                if (isContributorInputValid(sub)) {
                                    sumOfSubEffectiveScores += getContributorEffectiveAllocationScore(sub); // A_s = (R_s or R_s^2) * M_s
                                }
                            });
                            
                            contributor.subParticipants.forEach(sub => {
                                if (isContributorInputValid(sub)) {
                                    const subEffectiveScore = getContributorEffectiveAllocationScore(sub);
                                    let subParticipantRatio = 0;
                                    if (sumOfSubEffectiveScores > 0) {
                                        // Ratio_s = Ratio_Group * (A_s / Sum(A_s))
                                        subParticipantRatio = contributorFinalRatio * (subEffectiveScore / sumOfSubEffectiveScores);
                                    }
                                    const sRawScore = getContributorRawScore(sub);

                                    ALL_FINAL_RESULTS.push({
                                        largeOrgName: largeOrg.name,
                                        smallOrgName: smallOrg.name,
                                        groupName: contributor.name,
                                        name: sub.name,
                                        finalRatio: subParticipantRatio,
                                        type: 'Sub-Participant', // For report
                                        scarcity: sub.scarcity,
                                        causality: sub.causality,
                                        breakthrough: sub.breakthrough,
                                        multi: sub.multi,
                                        factorGroupMulti: contributor.multi, // The multi of the parent group
                                        rawScore: sRawScore, 
                                        allocationScore: subEffectiveScore
                                    });
                                }
                            });
                        }
                    });
                });
            }

            // Global Ratio Placeholder
            if (ratioMode === 'global' && currentFinalOrgRatios.length === 0) {
                currentFinalOrgRatios.push({ name: keys.mode_global, ratio: 100, score: grandTotalAllocationScore });
            }


            // 3. Display Results
            ALL_FINAL_RESULTS.sort((a, b) => a.name.localeCompare(b.name));
            currentDetailedResults = ALL_FINAL_RESULTS; 

            // --- Org Results ---
            let orgHtml = currentFinalOrgRatios.map(org => {
                const displayName = getDisplayableName(org.name); 
                return `
                    <div class="flex justify-between border-b border-gray-300 pb-1 last:border-b-0">
                        <span class="text-sm text-secondary font-medium">${displayName} (${scoreLabelBase}: ${org.score.toFixed(2)})</span>
                        <span class="text-lg font-bold ${ratioMode === 'global' ? 'text-green-600' : 'text-blue-600'}">${org.ratio.toFixed(2)}%</span>
                    </div>
                `;
            }).join('');
            largeOrgResults.innerHTML = orgHtml;

            // --- Detailed Participant Results ---
            let participantHtml = ALL_FINAL_RESULTS.map(p => {
                const largeOrgDisplayName = getDisplayableName(p.largeOrgName);
                const smallOrgDisplayName = getDisplayableName(p.smallOrgName);
                const groupInfo = p.groupName ? ` / G: ${getDisplayableName(p.groupName)}` : '';
                const typeColor = p.type === 'Sub-Participant' ? 'text-purple-500' : 'text-amber-500';

                return `
                    <div class="border-b border-gray-200 pb-1 last:border-b-0">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-800 font-medium">${p.name} <span class="text-xs ${typeColor}">(${p.type})</span></span>
                            <span class="text-md font-bold text-primary">${p.finalRatio.toFixed(2)}%</span>
                        </div>
                        <p class="text-xs text-gray-500 italic">(${largeOrgDisplayName} / ${smallOrgDisplayName}${groupInfo} / M:${p.multi})</p>
                    </div>
                `;
            }).join('');
            participantResults.innerHTML = participantHtml;

            // --- Aggregated Summary ---
            const aggregatedMap = {};
            ALL_FINAL_RESULTS.forEach(item => {
                const normName = item.name.trim();
                if (aggregatedMap[normName]) {
                    aggregatedMap[normName] += item.finalRatio;
                } else {
                    aggregatedMap[normName] = item.finalRatio;
                }
            });

            const aggregatedResults = Object.keys(aggregatedMap).map(name => ({
                name: name,
                totalRatio: aggregatedMap[name]
            })).sort((a, b) => a.name.localeCompare(b.name));
            
            currentAggregatedResults = aggregatedResults;

            let aggregatedHtml = aggregatedResults.map(p => `
                <div class="flex justify-between items-center border-b border-blue-200 pb-2 last:border-b-0 py-1">
                    <span class="text-base text-gray-900 font-bold">${p.name}</span>
                    <span class="text-lg font-bold text-emerald-600">${p.totalRatio.toFixed(2)}%</span>
                </div>
            `).join('');
            participantAggregatedResults.innerHTML = aggregatedHtml;

            resultsContainer.classList.remove('hidden');
            downloadButton.classList.remove('hidden');
        }
        
        // --- Summary Report Function (Updated for Custom Format) ---
        function downloadSummaryReport() {
    const keys = translations[getLang()];
    if (currentAggregatedResults.length === 0 || currentDetailedResults.length === 0) {
        alert(keys.error_message_validation);
        return;
    }
    const now = new Date(); 
    // 格式化日期为 YYYY-MM-DD HH:mm:ss
    const dateString = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
    
    const escapeCsv = (val) => {
        if (typeof val === 'number') return val.toFixed(4); // 保持4位小数精度 
        if (val === null || val === undefined) return ''; 
        let str = String(val).trim(); 
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
    };
    
    const getModeText = (mode) => {
        if (mode === 'additive') return keys.mode_additive || "Additive"; 
        if (mode === 'multiplicative') return keys.mode_multiplicative || "Multiplicative"; 
        if (mode === 'squared') return "Squared"; 
        if (mode === 'linear') return "Linear"; 
        if (mode === 'hierarchical') return keys.mode_hierarchical.replace(' - Default', '').replace(' - Default', ''); 
        if (mode === 'global') return keys.mode_global; 
        if (mode === 'squaredAdditive') return "Squared Accumulation (S+C+B & R²/ΣR)"; 
        if (mode === 'linearMultiplicative') return "Linear Multiplication (Seff×Ceff×Beff & R/ΣR)"; 
        return mode;
    };
    const getWeightingText = (weighting) => {
        if (weighting === 'squared') return "Squared Weighted (R²/ΣR²)";
        if (weighting === 'linear') return "Linear Weighted (R/ΣR)";
        return weighting;
    }
    const getRatioText = (ratio) => {
        if (ratio === 'hierarchical') return keys.mode_hierarchical.replace(' - Default', '').replace(' - Default', '');
        if (ratio === 'global') return keys.mode_global.replace(' - Default', '').replace(' - Default', '');
        return ratio;
    }

    // --- Section 1: Header/Metadata ---
    let csvContent = `# ${keys.report_title}\n`;
    csvContent += `#Section 1: Header/Metadata\n`;
    csvContent += `Report Title,${escapeCsv(keys.report_title)}\n`;
    csvContent += `Generation Date,${dateString}\n`;
    csvContent += `Calculation Mode,${escapeCsv(getModeText(aggregationMode) + ' + ' + getWeightingText(weightingLogic))}\n`;
    csvContent += `Ratio Computation Mode,${escapeCsv(getRatioText(ratioMode))}\n`;
    csvContent += `\n`;

    // --- Section 1.2: Major Roles Ratios ---
    if (currentFinalOrgRatios.length > 0 && ratioMode === 'hierarchical') {
        csvContent += `#Section 1.2: Major Roles Ratios\n`;
        csvContent += `Major Roles,Relative Ratio (%)\n`;
        // Filter out global ratio placeholder if hierarchical mode
        currentFinalOrgRatios.filter(o => ratioMode !== 'global' || o.name !== keys.mode_global).forEach(org => {
            csvContent += `${escapeCsv(getDisplayableName(org.name))},${org.ratio.toFixed(4)}\n`;
        });
        csvContent += `\n`;
    }

    // --- Section 2: Contribution Base Data Fields (User Requested) ---
    csvContent += `#Section 2: Contribution Data Fields\n`;
    // 修改后的表头：将“是否是小组”修改为“是否属于某一小组”，并删除了“是否是子参与者”
    csvContent += `Participant/Group/Sub-Participant,Belongs to a Group,Group Name,Major Roles,Minor Roles,Probability (P),Causality (C),Remoteness (R),Multi,Group Multi\n`;
    currentDetailedResults.forEach(item => {
        // '是否属于某一小组': '是' if Sub-Participant
        const belongsToGroup = item.type === 'Sub-Participant' ? 'Yes' : 'No'; 
        // '小组名': Use groupName if Sub-Participant, else empty
        const groupName = item.type === 'Sub-Participant' ? item.groupName : ''; 
        // '是否是子参与者' 已删除
        
        // Construct the row, outputting the updated fields
        csvContent += `${escapeCsv(item.name)},${belongsToGroup},${escapeCsv(groupName)},${escapeCsv(getDisplayableName(item.largeOrgName))},${escapeCsv(getDisplayableName(item.smallOrgName))},${item.scarcity.toFixed(0)},${item.causality.toFixed(0)},${item.breakthrough.toFixed(0)},${item.multi.toFixed(0)},${item.factorGroupMulti.toFixed(0)}\n`;
    });
    csvContent += `\n`;


    // --- Section 3.1: Aggregated Results (Modified from original Section 3.1) ---
    let groupMap = new Map();
    const groupOrderList = [];
    currentDetailedResults.forEach(item => {
        // The aggregation is by participant/group.
        const isGroupEntry = item.type === 'Sub-Participant'; 
        const entryName = isGroupEntry ? item.groupName : item.name;
        const entryType = isGroupEntry ? 'Group' : 'Individual';

        // Unique key: Name + LargeOrg + SmallOrg (for groups use GroupName, for individuals use Name)
        const uniqueKey = entryName + '|||' + item.largeOrgName + '|||' + item.smallOrgName; 

        if (!groupMap.has(uniqueKey)) {
            groupMap.set(uniqueKey, { 
                name: entryName, 
                largeOrg: item.largeOrgName, 
                smallOrg: item.smallOrgName, 
                ratio: 0, 
                type: entryType 
            });
            groupOrderList.push(uniqueKey);
        }
        // Aggregate ratio
        groupMap.get(uniqueKey).ratio += item.finalRatio;
    });
    
    csvContent += `#Section 3.1: Aggregated Results\n`;
    csvContent += `Participant/Group Name,Major Roles,Minor Roles,Final Contribution Ratio(%)\n`;
    groupOrderList.forEach(key => {
        const data = groupMap.get(key);
        csvContent += `${escapeCsv(data.name)},${escapeCsv(getDisplayableName(data.largeOrg))},${escapeCsv(getDisplayableName(data.smallOrg))},${data.ratio.toFixed(4)}\n`;
    });
    csvContent += `\n`;

    // --- Section 3.2: Detailed Results (Modified from original Section 3.2) ---
    csvContent += `#Section 3.2: Detailed Results\n`;
    csvContent += `Participant/Sub-Participant Name,Major Roles,Minor Roles,Final Contribution Ratio (%)\n`;
    currentDetailedResults.forEach(p => {
        csvContent += `${escapeCsv(p.name)},${escapeCsv(getDisplayableName(p.largeOrgName))},${escapeCsv(getDisplayableName(p.smallOrgName))},${p.finalRatio.toFixed(4)}\n`;
    });
    csvContent += `\n`;

    // --- Section 4: Footer & Disclaimer (Modified from original Section 4) ---
    csvContent += `#Section 4: Footer & Disclaimer\n`;
    csvContent += `Endorsement Description,Report generated by QuIReC V5.2\n`;
    csvContent += `Statement,This report is generated based on the QuIReC (Three-Factor Tiering Method) rules. The results aim to provide an objective reference for contribution, and their accuracy is entirely dependent on the reasonableness of the data input by the user.\n`;
    csvContent += `\n`;

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `QuIReC_Report_${dateString.replace(/[\s:]/g, '-')}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

        // --- Utility and Initialization (Mostly Unchanged) ---
        
        function updateFileInputLabel(input) {
            const fileNameDisplay = document.getElementById('fileSelectedName');
            const label = document.getElementById('customFileInputLabel');
            const keys = translations[getLang()];
            
            if (!fileNameDisplay || !label) return;

            if (input.files.length > 0) {
                fileNameDisplay.textContent = input.files[0].name;
                label.textContent = keys.file_ready;
                label.classList.remove('text-gray-700', 'bg-white', 'border-gray-400', 'hover:bg-gray-100');
                label.classList.add('text-green-700', 'bg-green-50', 'border-green-400', 'font-bold', 'hover:bg-green-100');
            } else {
                label.textContent = keys.file_input_placeholder;
                fileNameDisplay.textContent = keys.no_file_selected;
                label.classList.remove('text-green-700', 'bg-green-50', 'border-green-400', 'font-bold', 'hover:bg-green-100');
                label.classList.add('text-gray-700', 'bg-white', 'border-gray-400', 'hover:bg-gray-100');
            }
        }

        function handleFileUpload() { 
    const fileInput = document.getElementById('csvFile');
    const statusElement = document.getElementById('uploadStatus');
    const keys = translations[getLang()];
    
    if (fileInput.files.length === 0) {
        statusElement.textContent = keys.no_file_selected;
        statusElement.className = "mt-2 text-sm text-red-600";
        statusElement.classList.remove('hidden');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const csvText = e.target.result;
        
        // 1. 解析 CSV 文本，获取贡献计算基础数据
        const contributionData = parseCsvData(csvText);

        if (contributionData && contributionData.length > 0) {
            // 2. 将数据导入到 largeOrgs 结构中
            const success = importContributionData(contributionData);
            
            if (success) {
                // 3. 导入成功：重新渲染并计算
                renderHierarchy(); 
                calculateContributions();
                
                statusElement.textContent = keys.csv_upload_success;
                statusElement.className = "mt-2 text-sm text-green-600";
                statusElement.classList.remove('hidden');
                
                // 确保所有新生成的元素也被翻译
                setLanguage(getLang());
                
                return;
            }
        }
        
        // 导入失败或数据为空
        statusElement.textContent = keys.csv_upload_error;
        statusElement.className = "mt-2 text-sm text-red-600";
        statusElement.classList.remove('hidden');
    };
    
    reader.readAsText(file, 'UTF-8');
}

        // --- NEW CSV IMPORT LOGIC (Replaces old simple hierarchy parser) ---

/**
 * 通用 CSV 解析器，用于查找特定的“贡献计算基础数据字段”部分并将其解析为对象数组。
 * @param {string} csvText - 完整的 CSV 文件内容。
 * @returns {Array<Object>|null} 解析出的数据行，或 null。
 */
function parseCsvData(csvText) {
    const lines = csvText.split(/\r\n|\n/);
    const data = [];
    let headers = [];
    let startParsing = false;

    // 严格匹配导出的表头行
    const targetHeaderLine = 'Participant/Group/Sub-Participant,Belongs to a Group,Group Name,Major Roles,Minor Roles,Probability (P),Causality (C),Remoteness (R),Multi,Group Multi';
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        // 查找特定的报告章节起始标记
        if (line.startsWith('#Section 2: Contribution Data Fields')) {
            // 找到章节标记，下一行应该是表头
            if (i + 1 < lines.length) {
                const headerLine = lines[i + 1].trim();
                // 严格匹配表头
                if (headerLine === targetHeaderLine) {
                    headers = headerLine.split(',').map(h => h.trim());
                    startParsing = true;
                    i++; // 跳过表头行
                    continue;
                }
            }
        }

        if (startParsing && line.length > 0 && !line.startsWith('#')) {
            // 简单的 CSV 解析，处理引号和逗号分隔
            const values = [];
            let inQuote = false;
            let currentField = '';
            for (let j = 0; j < line.length; j++) {
                const char = line[j];

                if (char === '"') {
                    // 处理转义引号（例如："" 变成了 "）
                    if (j + 1 < line.length && line[j + 1] === '"' && inQuote) {
                        currentField += '"';
                        j++; // 跳过下一个引号
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    values.push(currentField);
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            values.push(currentField); // 最后一个字段

            if (values.length === headers.length) {
                const rowData = {};
                headers.forEach((header, index) => {
                    rowData[header] = values[index];
                });
                data.push(rowData);
            }
        }
    }

    if (!startParsing || data.length === 0) {
        return null; // 如果未找到特定章节或数据为空，则返回 null
    }

    return data;
}

/**
 * 将解析出的贡献基础数据导入到全局 largeOrgs 结构中。
 * @param {Array<Object>} data - 从 CSV 解析出的贡献数据行。
 * @returns {boolean} 导入是否成功。
 */
function importContributionData(data) {
    if (!data || data.length === 0) {
        return false;
    }

    // 重置数据结构和 ID 计数器
    largeOrgs = [];
    nextLargeOrgId = 1;
    nextSmallOrgId = 100;
    nextGroupId = 1000;
    nextParticipantId = 10000;

    // Map 用于快速查找和构建层级结构
    const largeOrgMap = new Map(); 
    const smallOrgMap = new Map(); 
    const groupMap = new Map();    
    // 字段映射常量
    const FIELD_NAME = 'Participant/Group/Sub-Participant';
    const FIELD_IS_GROUP = 'Belongs to a Group';
    const FIELD_GROUP_NAME = 'Group Name';
    const FIELD_MAJOR_ROLE = 'Major Roles';
    const FIELD_MINOR_ROLE = 'Minor Roles';
    const FIELD_S = 'Probability (P)';
    const FIELD_C = 'Causality (C)';
    const FIELD_B = 'Remoteness (R)';
    const FIELD_MULTI = 'Multi';
    const FIELD_GROUP_MULTI = 'Group Multi';
    data.forEach(row => {
        const majorRoleName = row[FIELD_MAJOR_ROLE];
        const minorRoleName = row[FIELD_MINOR_ROLE];
        const participantName = row[FIELD_NAME];
        const isSubParticipant = row[FIELD_IS_GROUP] === 'Yes';
        const groupName = row[FIELD_GROUP_NAME];
        const groupMultiValue = parseFloat(row[FIELD_GROUP_MULTI]) || 1;

        if (!majorRoleName || !minorRoleName || !participantName) {
            console.warn("Skipping row due to missing required fields:", row);
            return; 
        }

        // 1. 确保大贡献项存在
        if (!largeOrgMap.has(majorRoleName)) {
            const newLargeOrg = {
                id: nextLargeOrgId++,
                name: majorRoleName,
                weightedAverageScore: 0,
                smallOrgs: []
            };
            largeOrgs.push(newLargeOrg);
            largeOrgMap.set(majorRoleName, newLargeOrg);
        }
        const currentLargeOrg = largeOrgMap.get(majorRoleName);

        // 2. 确保小贡献项存在
        const smallOrgKey = `${majorRoleName}|||${minorRoleName}`;
        if (!smallOrgMap.has(smallOrgKey)) {
            const newSmallOrg = {
                id: nextSmallOrgId++,
                name: minorRoleName,
                weightedAverageScore: 0,
                contributors: []
            };
            currentLargeOrg.smallOrgs.push(newSmallOrg);
            smallOrgMap.set(smallOrgKey, newSmallOrg);
        }
        const currentSmallOrg = smallOrgMap.get(smallOrgKey);

        // 3. 构建贡献者数据 (Participant/Sub-Participant)
        const contributorData = {
            id: nextParticipantId++,
            name: participantName,
            scarcity: parseFloat(row[FIELD_S]) || 0,
            causality: parseFloat(row[FIELD_C]) || 0,
            breakthrough: parseFloat(row[FIELD_B]) || 0,
            multi: parseFloat(row[FIELD_MULTI]) || 1
        };

        if (isSubParticipant) {
            // A. 子参与者：查找或创建父级小组
            const groupKey = `${smallOrgKey}|||${groupName}`;
            let currentGroup;

            if (!groupMap.has(groupKey)) {
                // 创建新的小组
                currentGroup = {
                    id: nextGroupId++,
                    type: 'group',
                    name: groupName || `Group ${nextGroupId}`, 
                    multi: groupMultiValue, // 【修改此行】: 使用导入的 groupMultiValue
                    weightedAverageScore: 0,
                    totalEffectiveAllocationScore: 0,
                    subParticipants: []
                };
                currentSmallOrg.contributors.push(currentGroup);
                groupMap.set(groupKey, currentGroup);
            } else {
                currentGroup = groupMap.get(groupKey);
            }

            // 添加子参与者到小组
            currentGroup.subParticipants.push(contributorData);

        } else {
            // B. 个体参与者
            currentSmallOrg.contributors.push({
                ...contributorData,
                type: 'individual'
            });
        }
    });

    // 4. 标记为已导入的自定义结构
    customHierarchyStructure = 'ImportedFullData'; 
    return true;
}

// --- UPDATED FUNCTION: handleFileUpload ---

        function initializeHierarchy(structureToUse) {
            largeOrgs = [];
            nextLargeOrgId = 1;
            nextSmallOrgId = 100;
            nextGroupId = 1000;
            nextParticipantId = 10000;
            
            for (const largeOrgName in structureToUse) {
                if (Object.hasOwnProperty.call(structureToUse, largeOrgName)) {
                    const smallOrgNames = structureToUse[largeOrgName];
                    addLargeOrganization(largeOrgName, smallOrgNames); 
                }
            }

            renderHierarchy(); 
            
            document.getElementById('resultsContainer').classList.add('hidden'); 
            document.getElementById('downloadReportButton').classList.add('hidden'); 

            // Initial calculation to update displays
            largeOrgs.forEach(org => {
                org.smallOrgs.forEach(sub => calculateSmallOrgScore(org.id, sub.id));
                calculateLargeOrgScore(org.id);
            });
        }
        
        function downloadExampleFile() {
            const dateString = new Date().toISOString().split('T')[0];
            
            const BOM = "\ufeff"; 
            const finalContent = BOM + EXAMPLE_CSV_CONTENT;

            const blob = new Blob([finalContent], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `QuIReC_Example_Roles_${dateString}.csv`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => {
                URL.revokeObjectURL(link.href);
            }, 100); 
        }

        function setLanguage(lang) {
            const elements = document.querySelectorAll('[data-key]');
            const keys = translations[lang];

            elements.forEach(element => {
                const key = element.getAttribute('data-key');
                if (keys && keys[key]) {
                    if (element.tagName === 'TITLE') {
                        document.title = keys[key];
                    } else if (element.tagName === 'INPUT' && element.placeholder) {
                        element.placeholder = keys[key];
                    } else if (element.tagName === 'LABEL' && element.id === 'customFileInputLabel') {
                        const fileInput = document.getElementById('csvFile');
                        if (fileInput && fileInput.files.length > 0) {
                            element.textContent = keys.file_ready;
                        } else {
                            element.textContent = keys.file_input_placeholder;
                        }
                    } else if (element.tagName !== 'INPUT' && element.tagName !== 'TEXTAREA') {
                        element.textContent = keys[key];
                    }
                }
            });
            
            const fileSelectedName = document.getElementById('fileSelectedName');
            if (fileSelectedName) {
                const fileInput = document.getElementById('csvFile');
                 if (!fileInput || fileInput.files.length === 0) {
                    fileSelectedName.textContent = keys.no_file_selected;
                }
            }

            renderHierarchy(); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('language-selector');
            const currentLang = selector.value || 'zh';
            
            document.getElementById('downloadReportButton').classList.add('hidden'); 
            document.getElementById('uploadStatus').classList.add('hidden'); 

            const initialDefaultStructure = currentLang === 'en' ? hierarchyStructureEN : getDefaultStructureZH();
            
            initializeHierarchy(initialDefaultStructure);

            selector.addEventListener('change', (event) => {
        const newLang = event.target.value;
        let targetUrl = '';
        
        if (newLang === 'en') {
            targetUrl = 'QuIReC_calculator_Chinese.html'; // 链接到英文版
        } else if (newLang === 'bi') {
            targetUrl = 'hierarchical_calculator.html'; // 链接到中英双语版
        }

        if (targetUrl) {
            // 执行页面重定向
            window.location.href = targetUrl;
        } else {
            // 保持在当前的中文页面，并确保加载中文默认设置
            const newStructure = customHierarchyStructure || getDefaultStructureZH();
            initializeHierarchy(newStructure);
            setLanguage('zh'); 
            // 确保 dropdown 保持在 'zh' 选项，以防用户在中文页选择中文
            event.target.value = 'zh';
        }
    });
            
            setLanguage(currentLang);
            updateFileInputLabel(document.getElementById('csvFile'));
        });
    </script>
    
    <footer class="mt-16 w-full max-w-5xl border-t pt-8 text-center text-secondary text-sm pb-8">
        <p class="font-semibold mb-2">&copy; 2025 QuIReC. All rights reserved.</p>
        <p class="text-gray-500 text-xs">
            This calculator is based on QuIReC.<br>
            Powered by Google Gemini Large Language Model for development assistance.
        </p>
    </footer>

</body>
</html>
