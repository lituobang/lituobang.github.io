<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Discrete Markov UBI Simulator v3.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f8f9fa; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; margin-bottom: 5px; color: #2c3e50; }
        h4 { text-align: center; margin-top: 0; color: #7f8c8d; font-weight: normal; }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #dee2e6; }
        .stat-val { font-size: 22px; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 12px; color: #666; margin-top: 5px; line-height: 1.2; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #f1f3f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        canvas { background: #fff; border: 1px solid #eee; border-radius: 8px; }
        .log-box { height: 100px; overflow-y: scroll; background: #343a40; color: #2ecc71; font-family: monospace; padding: 10px; font-size: 11px; margin-top: 15px; border-radius: 4px; }
        .lang-sep { border-top: 1px solid #ccc; margin: 10px 0; padding-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>异步平滑全民基本收入发放模拟</h2>
    <h4>Asynchronously Smoothed UBI Simulator</h4>
    
    <div class="stat-grid">
        <div class="stat-box">
            <div class="stat-val" id="current-t">0</div>
            <div class="stat-label">周期 (t)<br>Cycles (t)</div>
        </div>
        <div class="stat-box">
            <div class="stat-val" id="active-count">0</div>
            <div class="stat-label">本期发放人数<br>Recipients (t)</div>
        </div>
        <div class="stat-box">
            <div class="stat-val" id="max-water">0</div>
            <div class="stat-label">最高水位<br>Max Water-level</div>
        </div>
        <div class="stat-box" style="background:#d4edda;">
            <div class="stat-val" id="variance">0%</div>
            <div class="stat-label">变异系数 (相对方差)<br>Coeff. of Variation</div>
        </div>
    </div>

    <div class="controls">
        <div>
            <label><strong>本期计划发放总名额 / Quota:</strong></label>
            <input type="range" id="quotaRange" min="1" max="40" value="10" style="width:100%">
            <span id="quotaVal">10</span> 人/Persons
            <p style="font-size:11px; color:#666; margin-top:5px;">
                由通胀情况决定发放规模<br>
                Quota is determined by inflation feedback.
            </p>
        </div>
        <div>
            <label><strong>单次发放金额 / Unit Amount:</strong></label>
            <input type="number" id="unitAmount" value="50" style="width:80px; padding:5px;">
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button onclick="simulateStep()" style="background:#007bff; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer; flex:1;">执行抽样 / Step</button>
                <button onclick="autoSimulate()" id="autoBtn" style="background:#28a745; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer; flex:1;">自动运行 / Auto</button>
            </div>
        </div>
    </div>

    <canvas id="ubiChart"></canvas>
    
    <div style="text-align: right; margin-top: 10px;">
        <button onclick="resetSim()" style="background:#6c757d; color:white; border:none; padding:5px 12px; border-radius:4px; cursor:pointer; font-size:12px;">系统重置 / Reset System</button>
    </div>

    <div class="log-box" id="logBox">System Ready. Waiting for signals...</div>
</div>

<script>
    const N = 40; 
    let t = 0;
    let data = Array(N).fill(0).map(() => ({ cumulative: 0, count: 0 }));
    let isAuto = false;
    let autoTimer = null;

    const ctx = document.getElementById('ubiChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array(N).fill(0).map((_, i) => `${i+1}`),
            datasets: [{
                label: '累积发放金额 / Cumulative UBI (Discrete)',
                data: Array(N).fill(0),
                backgroundColor: (context) => {
                    return context.raw > 0 ? '#3498db' : '#dee2e6';
                },
                borderColor: '#2980b9',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            animation: { duration: 150 }
        }
    });

    function simulateStep() {
        t++;
        const quota = parseInt(document.getElementById('quotaRange').value);
        const unitAmt = parseFloat(document.getElementById('unitAmount').value);
        const L_max = Math.max(...data.map(d => d.cumulative), 1);
        
        // 1. Calculate Markov Weights (Probability Hedging)
        let weights = data.map(indiv => {
            const phi = indiv.cumulative / (t || 1); // Frequency of receipt
            const waterGap = L_max - indiv.cumulative; // Distance from leader
            // Penalty for continuity (phi) and Reward for lagging (waterGap)
            return Math.exp(1.5 * (waterGap / 10) - 2.5 * phi);
        });

        // 2. Weighted Random Sampling without replacement
        let winners = [];
        let tempWeights = [...weights];
        let availableIndices = Array.from({length: N}, (_, i) => i);

        for (let i = 0; i < Math.min(quota, N); i++) {
            let sumW = tempWeights.reduce((a, b) => a + b, 0);
            let r = Math.random() * sumW;
            let cumulativeW = 0;
            for (let j = 0; j < availableIndices.length; j++) {
                cumulativeW += tempWeights[j];
                if (r <= cumulativeW) {
                    winners.push(availableIndices[j]);
                    availableIndices.splice(j, 1);
                    tempWeights.splice(j, 1);
                    break;
                }
            }
        }

        // 3. Update State
        data = data.map((indiv, i) => {
            if (winners.includes(i)) {
                return { cumulative: indiv.cumulative + unitAmt, count: indiv.count + 1 };
            }
            return indiv;
        });

        logToBox(`Cycle ${t}: ${winners.length} recipients. Index: ${winners.map(v=>v+1).join(',')}`);
        updateUI(winners.length);
    }

    function updateUI(winCount) {
        chart.data.datasets[0].data = data.map(d => d.cumulative);
        chart.update();

        const curMax = Math.max(...data.map(d => d.cumulative));
        const mean = data.reduce((a, b) => a + b.cumulative, 0) / N;
        const variance = data.reduce((a, b) => a + Math.pow(b.cumulative - mean, 2), 0) / N;
        
        // Use Coeff of Variation (CV) to represent relative inequality
        // It should drop as time goes on, showing long-term convergence
        const cv = mean > 0 ? (Math.sqrt(variance) / mean) : 0;

        document.getElementById('current-t').innerText = t;
        document.getElementById('active-count').innerText = winCount;
        document.getElementById('max-water').innerText = curMax.toFixed(0);
        document.getElementById('variance').innerText = (cv * 100).toFixed(1) + "%";
        document.getElementById('quotaVal').innerText = document.getElementById('quotaRange').value;
    }

    function logToBox(msg) {
        const box = document.getElementById('logBox');
        box.innerHTML += `<br>> ${msg}`;
        box.scrollTop = box.scrollHeight;
    }

    function autoSimulate() {
        isAuto = !isAuto;
        document.getElementById('autoBtn').innerText = isAuto ? "停止 / Stop" : "自动运行 / Auto";
        if (isAuto) {
            autoTimer = setInterval(simulateStep, 300);
        } else {
            clearInterval(autoTimer);
        }
    }

    function resetSim() {
        t = 0;
        data = Array(N).fill(0).map(() => ({ cumulative: 0, count: 0 }));
        if (isAuto) autoSimulate();
        updateUI(0);
        document.getElementById('logBox').innerHTML = "System Reset.";
    }
</script>
</body>
</html>
